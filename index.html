<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitsplan</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
    <script>
        // Überprüfe, ob der Benutzer eingeloggt ist
        window.onload = function() {
            // Warte auf Firebase Auth
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged(function(authUser) {
                    if (!authUser) {
                        // Benutzer nicht authentifiziert, leite zur Login-Seite weiter
                        console.log('Benutzer nicht authentifiziert, leite zur Login-Seite weiter');
                        window.location.href = 'login.html';
                    } else {
                        // Prüfe, ob E-Mail verifiziert ist und Domain korrekt ist
                        if (!authUser.emailVerified) {
                            console.log('E-Mail nicht verifiziert');
                            firebase.auth().signOut().then(() => {
                                window.location.href = 'login.html';
                            });
                        } else if (!authUser.email || !authUser.email.endsWith('@knoebel-fliesen.de')) {
                            console.log('E-Mail-Domain nicht erlaubt');
                            firebase.auth().signOut().then(() => {
                                window.location.href = 'login.html';
                            });
                        } else {
                            console.log('Benutzer authentifiziert:', authUser.email);
                            // Speichere Benutzerinformationen im localStorage für Kompatibilität
                            localStorage.setItem('currentUser', JSON.stringify({
                                email: authUser.email,
                                uid: authUser.uid,
                                emailVerified: authUser.emailVerified
                            }));
                        }
                    }
                });
            } else {
                // Firebase Auth nicht verfügbar, leite zur Login-Seite weiter
                console.warn('Firebase Auth nicht verfügbar');
                window.location.href = 'login.html';
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Arbeitsplan</h1>
            <button id="logoutButton" class="logout-button">Ausloggen</button>
        </header>

        <div class="calendar-header">
            <div id="yearGrid" class="year-grid"></div>
            <div id="monthGrid" class="month-grid"></div>
        </div>

        <div class="status-buttons">
            <button class="status-button" data-status="urlaub">Urlaub</button>
            <button class="status-button" data-status="krank">Krankheit</button>
            <button class="status-button" data-status="unbezahlt">Unbezahlter Urlaub</button>
            <button class="status-button" data-status="schulung">Schule</button>
            <button class="status-button" data-status="feiertag">Feiertag</button>
            <button class="status-button" data-status="kurzarbeit">Kurzarbeit</button>
            <button class="status-button" data-status="abgerechnet">Abgerechnet</button>
        </div>

        <!-- Farbmarkierung für ausgewählte Felder (nur visuell, ohne Datenänderung) -->
        <div class="highlight-controls">
            <div class="highlight-header">
                <span class="highlight-title">Farbmarkierung</span>
                <div class="highlight-header-buttons">
                    <button id="applyHighlight" class="highlight-apply-button">Auf markierte Felder anwenden</button>
                    <button id="clearHighlight" class="highlight-clear-button">Farbmarkierung löschen</button>
                </div>
            </div>
            <div class="highlight-opacity-row">
                <label for="highlightOpacity">Deckkraft:</label>
                <input type="range" id="highlightOpacity" min="10" max="100" value="40">
                <span id="highlightOpacityValue">40%</span>
            </div>
            <div class="highlight-swatches">
                <!-- Vordefinierte Farbpalette (ca. 30 Farben) -->
                <div class="highlight-color-swatch" data-color="#ff5252"></div>
                <div class="highlight-color-swatch" data-color="#ff8a80"></div>
                <div class="highlight-color-swatch" data-color="#ffb74d"></div>
                <div class="highlight-color-swatch" data-color="#ffd54f"></div>
                <div class="highlight-color-swatch" data-color="#fff176"></div>
                <div class="highlight-color-swatch" data-color="#cddc39"></div>
                <div class="highlight-color-swatch" data-color="#aed581"></div>
                <div class="highlight-color-swatch" data-color="#81c784"></div>
                <div class="highlight-color-swatch" data-color="#4caf50"></div>
                <div class="highlight-color-swatch" data-color="#1b5e20"></div>

                <div class="highlight-color-swatch" data-color="#80cbc4"></div>
                <div class="highlight-color-swatch" data-color="#4db6ac"></div>
                <div class="highlight-color-swatch" data-color="#26a69a"></div>
                <div class="highlight-color-swatch" data-color="#0097a7"></div>
                <div class="highlight-color-swatch" data-color="#00bcd4"></div>
                <div class="highlight-color-swatch" data-color="#4fc3f7"></div>
                <div class="highlight-color-swatch" data-color="#2196f3"></div>
                <div class="highlight-color-swatch" data-color="#1e88e5"></div>
                <div class="highlight-color-swatch" data-color="#3f51b5"></div>
                <div class="highlight-color-swatch" data-color="#5c6bc0"></div>

                <div class="highlight-color-swatch" data-color="#9c27b0"></div>
                <div class="highlight-color-swatch" data-color="#ba68c8"></div>
                <div class="highlight-color-swatch" data-color="#e91e63"></div>
                <div class="highlight-color-swatch" data-color="#f06292"></div>
                <div class="highlight-color-swatch" data-color="#795548"></div>
                <div class="highlight-color-swatch" data-color="#8d6e63"></div>
                <div class="highlight-color-swatch" data-color="#b0bec5"></div>
                <div class="highlight-color-swatch" data-color="#90a4ae"></div>
                <div class="highlight-color-swatch" data-color="#eeeeee"></div>
                <div class="highlight-color-swatch" data-color="#bdbdbd"></div>
            </div>
        </div>

        <!-- Modal für Notizen (Popup) -->
        <div id="infoField" class="modal" style="display: none;">
            <div class="modal-content">
                <button id="closeInfoField" class="close-button-x">×</button>
                <h3>Notizen</h3>
                <textarea id="infoText" placeholder="Notizen eingeben..."></textarea>
                <div class="link-input">
                    <input type="text" id="linkInput" placeholder="Link eingeben...">
                    <button id="openLinkFolder" class="open-folder-btn">Ordner öffnen</button>
                </div>
                <div class="address-input">
                    <input type="text" id="addressInput" placeholder="Adresse eingeben...">
                    <button id="openMaps" class="maps-btn">Adresse in Maps öffnen</button>
                </div>
            </div>
        </div>

        <div class="calendar-container">
            <table class="calendar">
                <thead>
                    <tr id="headerRow"></tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
        </div>

        <div class="bottom-buttons">
            <button id="addEmployee">Mitarbeiter hinzufügen</button>
            <button id="exportData">Daten exportieren</button>
            <input type="file" id="importData" accept=".json" style="display: none;">
            <button id="importDataBtn">Daten importieren</button>
            <button id="showAuditLog">Änderungsprotokoll</button>
        </div>
    </div>

    <!-- Modal für neue Mitarbeiter -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <h2>Mitarbeiter hinzufügen</h2>
            <input type="text" id="employeeName" placeholder="Name des Mitarbeiters">
            <button id="saveEmployee">Speichern</button>
            <button id="cancelEmployee">Abbrechen</button>
        </div>
    </div>

    <!-- Modal für Mitarbeiter löschen -->
    <div id="deleteEmployeeModal" class="modal">
        <div class="modal-content">
            <h2>Mitarbeiter entfernen</h2>
            <p>Möchten Sie den Mitarbeiter <span id="employeeToDelete"></span> wirklich entfernen?</p>
            <button id="confirmDelete">Ja</button>
            <button id="cancelDelete">Nein</button>
        </div>
    </div>

    <!-- Modal für Export -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h2>Daten exportieren</h2>
            <div class="export-options">
                <div class="export-range">
                    <h3>Export-Bereich</h3>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="exportRange" value="currentMonth" checked>
                            Aktuellen Monat exportieren
                        </label>
                        <label>
                            <input type="radio" name="exportRange" value="all">
                            Gesamten Plan exportieren
                        </label>
                    </div>
                    <div id="yearSelection" style="display: none; margin-top: 15px;">
                        <label>
                            <strong>Jahr auswählen:</strong>
                            <select id="exportYear" style="margin-left: 10px; padding: 5px;">
                                <!-- Wird dynamisch gefüllt -->
                            </select>
                        </label>
                    </div>
                </div>
                <div class="export-formats">
                    <h3>Dateiformate</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" name="exportFormat" value="json" checked>
                            JSON-Datei
                        </label>
                        <label>
                            <input type="checkbox" name="exportFormat" value="excel" checked>
                            Excel-Datei
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="confirmExport">Exportieren</button>
                <button id="cancelExport">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal für Import-Rückgängig -->
    <div id="undoImportModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Import erfolgreich</h2>
            <p>Daten wurden erfolgreich importiert!</p>
            <p>Möchten Sie die Änderung rückgängig machen?</p>
            <div class="modal-buttons">
                <button id="confirmUndo">Ja</button>
                <button id="cancelUndo">Nein</button>
            </div>
        </div>
    </div>

    <script src="firebase-simple.js"></script>
    <script src="script.js"></script>
</body>
</html> 